#!/bin/bash

#Check if dependency flatpak is installed and install it if not
# Checks for package/dependencies installed status and installs them if not already installed
for PACKAGE in flatpak; do                                                             # the dependencies needed
    if ! apt list --installed $PACKAGE 2>/dev/null | grep -w $PACKAGE >/dev/null; then # the precursor condition to begin checking and installing dependencies
        echo "dependency $PACKAGE is NOT installed .. installing"
        sudo apt update
        sudo apt install -y $PACKAGE
        sudo apt install gnome-software-plugin-flatpak -y                                            #makes it possible to install apps without needing the command line
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo #add flathub repository
        if ! apt list --installed $PACKAGE 2>/dev/null | grep -w $PACKAGE >/dev/null; then           #exits if package is not installed even after installation code was executed...something went wrong
            echo "Posibly didn't install dependency $PACKAGE .. exiting"
            exit
        fi
    fi
done

CHOICE=$(whiptail --title "KVM VIRT-MANAGER SHORTCUTS INHIBITOR ENABLE/DISABLE" --menu "KVM VIRT-MANAGER SHORTCUTS INHIBITOR ENABLE/DISABLE" 0 0 2 \
    1 "[DISABLE SHORTCUT INHIBITION FOR KVM VIRT-MANAGER] {Shortcuts Will Be Taken Over By [Host] OS}" \
    2 "[ENABLE SHORTCUT INHIBITION FOR KVM VIRT-MANAGER] {Shortcuts Will Be Taken Over By [GUEST] OS}" \
    3 "[STATUS]" 3>&1 1>&2 2>&3)

if [ -z $CHOICE ]; then
    exit
elif [ $CHOICE -eq 1 ]; then

    flatpak permission-set gnome shortcuts-inhibitor virt-viewer.desktop DENIED
    flatpak permission-set gnome shortcuts-inhibitor virt-viewer.desktop DENIED
    flatpak permission-set gnome shortcuts-inhibitor qemu.desktop DENIED
    flatpak permission-set gnome shortcuts-inhibitor org.remmina.Remmina.desktop DENIED

    echo " KVM VIRT-MANAGER KEYBOARD SHORTCUTS  ENABLED [[HOST OS WILL TAKE OVER KEYBOARD SHORTCUTS]]"
elif [ $CHOICE -eq 2 ]; then
    flatpak permission-set gnome shortcuts-inhibitor virt-manager.desktop GRANTED
    flatpak permission-set gnome shortcuts-inhibitor virt-viewer.desktop GRANTED
    flatpak permission-set gnome shortcuts-inhibitor qemu.desktop GRANTED
    flatpak permission-set gnome shortcuts-inhibitor org.remmina.Remmina.desktop GRANTED

    echo " KVM VIRT-MANAGER KEYBOARD SHORTCUTS  INHIBITED ::: [[GUEST OS WILL TAKE OVER KEYBOARD SHORTCUTS]]"

elif [ $CHOICE -eq 3 ]; then
    echo status
    flatpak permission-list gnome shortcuts-inhibitor

fi

##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################
##############################################################################################################################################

#########  [[[[[[[[[[[[[[[        THE FOLLOWING CODE IS HERE FOR DOCUMENTATION PURPOSES ONLY          ]]]]]]]]]]]]]]]
#########  [[[[[[[[[[[[[[[        THE FOLLOWING CODE IS HERE FOR DOCUMENTATION PURPOSES ONLY          ]]]]]]]]]]]]]]]
#########  [[[[[[[[[[[[[[[        THE FOLLOWING CODE IS HERE FOR DOCUMENTATION PURPOSES ONLY          ]]]]]]]]]]]]]]]
#########  [[[[[[[[[[[[[[[        THE FOLLOWING CODE IS HERE FOR DOCUMENTATION PURPOSES ONLY          ]]]]]]]]]]]]]]]
#########  [[[[[[[[[[[[[[[        IT JUST DISABLES THE SWITCH WORKSPACE KEYBINDING VIA GSETTINGS ON HOST OS, HAS NO OFFECT ON KVM/VIRTMANAGER OR OTHER, JUST HERE FOR DOCUMENTATION      ]]]]]]]]]]]]]]]
# #!/bin/bash

# # Function to manage GNOME keyboard shortcut inhibition
# manage_shortcuts() {
#     local ACTION=$1
#     if [ "$ACTION" == "DENY" ]; then
#         echo "Disabling shortcut inhibition..."
#         # Example: Disable workspace switching shortcuts to prevent conflicts
#         gsettings set org.gnome.desktop.wm.keybindings switch-to-workspace-left "['']"
#         gsettings set org.gnome.desktop.wm.keybindings switch-to-workspace-right "['']"
#     elif [ "$ACTION" == "GRANT" ]; then
#         echo "Enabling shortcut inhibition ..."
#         # Reset GNOME workspace switching shortcuts to defaults
#         gsettings reset org.gnome.desktop.wm.keybindings switch-to-workspace-left
#         gsettings reset org.gnome.desktop.wm.keybindings switch-to-workspace-right
#     else
#         echo "Invalid action: $ACTION"
#     fi
# }

# # Display menu using whiptail
# CHOICE=$(whiptail --title "gsettings SHORTCUTS INHIBITOR" --menu "Choose an option:" 0 0 3 \
#     1 "Disable Shortcut Inhibition (Host OS)" \
#     2 "Enable Shortcut Inhibition (HOST OS)" \
#     3 "View Current GNOME Shortcut Settings" 3>&1 1>&2 2>&3)

# if [ $? -ne 0 ]; then
#     echo "No option selected. Exiting..."
#     exit 1
# fi

# case $CHOICE in
# 1) manage_shortcuts "DENY" ;;
# 2) manage_shortcuts "GRANT" ;;
# 3)
#     echo "Current GNOME Shortcut Settings:"
#     gsettings list-recursively org.gnome.desktop.wm.keybindings | grep switch-to-workspace
#     ;;
# *) echo "Invalid option. Exiting..." ;;
# esac
